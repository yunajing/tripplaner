<!DOCTYPE html>
<!-- saved from url=(0050)http://getbootstrap.com/examples/navbar-fixed-top/ -->
<html lang="en" version="g42dymwpi--nx">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="yj2270">

<title>Trip Planer</title>

<!-- Bootstrap core CSS -->
<link href="./styles/bootstrap.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="./styles/navbar-fixed-top.css" rel="stylesheet">
<link href="./styles/user_style.css" rel="stylesheet">
<link href="./styles/style.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="./styles/jquery-ui.css">
<link href="./styles/explorepage.css" type="text/css" rel="stylesheet">
<script src="./script/script.js"></script>
<script src="./script/filer.js"></script>
<script src="./script/jquery-1.10.2.min.js"></script>
<script type="text/javascript"></script>
<link href="./styles/leaflet.css" type="text/css" rel="stylesheet" />
<link href="./styles/apisamples.css" type="text/css" rel="stylesheet" />
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="./script/apisamples.js" type="text/javascript"></script>
<script src="./script/third_party/jquery.ba-bbq.js"
	type="text/javascript"></script>
<script src="./script/third_party/leaflet.js" type="text/javascript"></script>
<script src="./script/third_party/wax.leaf.min.js"
	type="text/javascript"></script>
<style>
    body { font-size: 62.5%; }
    label, input { display:block; }
    input.text { margin-bottom:12px; width:95%; padding: .4em; }
    fieldset { padding:0; border:0; margin-top:25px; }
    h1 { font-size: 12px; margin: .6em 0; }
    div#users-contain { width: 350px; margin: 20px 0; }
    div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
    div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
    .ui-dialog .ui-state-error { padding: .3em; }
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
</style>
<script>
  var clone;
  var selectedEvent;
  var vid;
  var tabCounter=0;
  var calenderList;
  var thisui;
  var unsavedCalenders={"Calenders":[]};
  var calendertemplate = '<div class="calendertime"><p>0:00 to 1:00</p><p>1:00 to 2:00</p><p>2:00 to 3:00</p><p>3:00 to 4:00</p><p>4:00 to 5:00</p><p>5:00 to 6:00</p><p>6:00 to 7:00</p><p>7:00 to 8:00</p><p>8:00 to 9:00</p><p>9:00 to 10:00</p><p>10:00 to 11:00</p><p>11:00 to 12:00</p><p>12:00 to 13:00</p><p>13:00 to 14:00</p><p>14:00 to 15:00</p><p>15:00 to 16:00</p><p>16:00 to 17:00</p><p>17:00 to 18:00</p><p>18:00 to 19:00</p><p>19:00 to 20:00</p><p>21:00 to 22:00</p><p>22:00 to 23:00</p><p>23:00 to 24:00</p></div><div class="calenderSlots"><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div><div class="drag_div ui-droppable"></div></div></div>';
  $(function() {
    $( document ).tooltip();
    $( "#delete" ).droppable({
      //accept: "#tabs",
      drop: function( event, ui ) {
        thisui = ui;
        console.log("You are trying to delete");
        $( "#delete-confirm" ).dialog("open");
      }
    });

    $( "#delete-confirm" ).dialog({
      resizable: false,
      autoOpen: false,
      height:140,
      modal: true,
      buttons: {
        "Delete all items": function() {
          deleteItem(thisui.draggable);
          $( this ).dialog( "close" );
        },
        Cancel: function() {
          $("#tabs").tabs("refresh");
          $( this ).dialog( "close" );
        }
      }
    });

    $( "#informationbox" ).dialog({
      resizable: false,
      autoOpen: false,
      height:140,
      modal: true,
      buttons: {
        "OK": function() {
          $( this ).dialog( "close" );
        },
      }
    });
  });
  function deleteItem( $item ) {
      $item.fadeOut();
      var itemid = $item.attr('id');
      console.log("Judging if deleted item is tag "+$item.attr('aria-controls'));
      console.log("Item being deleted is "+$item.attr('id'));
      if ($item.attr('aria-controls')!=null){
        var panelId = $item.remove().attr( "aria-controls" );
        console.log(panelId);
        $("#"+panelId).remove();
        $("#tabs").tabs( "refresh" );
        var k = findDuplicate(calenderList["Calenders"],itemid);
        var k2 = removeObjects(unsavedCalenders["Calenders"],"name",itemid);
        unsavedCalenders['Calenders'].splice(k2,1);
        if ( k != -1){
          calenderList["Calenders"].splice(k,1);
        }
        localStorage.removeItem("Calenders");
        localStorage.setItem("Calenders",JSON.stringify(calenderList));
        $("#information").text("Schedule "+itemid+" already deleted!");
        $("#informationbox").dialog("open");
        $("#tabs").tabs("refresh");
      }
      else if ($item.attr('id').substr(0,6)=="delete"){
        var scheduleid = $('#tabs').find(".ui-tabs-active").attr("id");
        console.log("Deleting event from schedule "+scheduleid);
        var k = findDuplicate(calenderList["Calenders"],scheduleid);
        var k2 = removeObjects(unsavedCalenders["Calenders"],"name",scheduleid);
        var eventid = removeObjects(unsavedCalenders["Calenders"][k2]["event"],"event-id",itemid.substr(7,itemid.length));
        unsavedCalenders["Calenders"][k2]["event"].splice(eventid,1);
        if (k!=-1){
          var tempSchedule = getObjects(unsavedCalenders["Calenders"],"name",scheduleid);
          localStorage.setItem(scheduleid,JSON.stringify(tempSchedule[0]));
        }
        $("#information").text("Event already deleted!");
        $("#informationbox").dialog("open");
      }
      $("#tabs").tabs("refresh");
  }

  function findDuplicate(array,val){
    for (var i = 0;i<array.length;i++){
      if (array[i]==val){
        return i;
      }
    }
    return -1;
  }
   function removeObjects(obj, key, val) {
    var indexes = [];
    for (var i=0;i<obj.length;i++) {
        if (obj[i][key] == val){
          return i;
        }
    }
    }
  function getObjects(obj, key, val) {
    var objects = [];
    for (var i in obj) {
        if (!obj.hasOwnProperty(i)) continue;
        if (typeof obj[i] == 'object') {
            objects = objects.concat(getObjects(obj[i], key, val));
        } else if (i == key && obj[key] == val) {
            objects.push(obj);
        }
    }
    return objects;
}

  $(function() {
    var tabTitle = $( "#tab_title" );
      tabDate = $( "#datepicker" );
      tabTemplate = "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>";
    tabDate.datepicker();
    // Create new calender dialog init
    var dialog = $( "#createCalendar" ).dialog({
      autoOpen: false,
      modal: true,
      buttons: {
        Add: function() {
          addTab();
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      },
      close: function() {
        form[ 0 ].reset();
      }
    });
 
    // addTab form: calls addTab function on submit and closes the dialog
    var form = dialog.find( "form" ).submit(function( event ) {
      addTab();
      dialog.dialog( "close" );
      event.preventDefault();
    });

     $( "#create" )
      .button()
      .click(function() {
        dialog.dialog( "open" );
        $( ".validateTips" )
                .text("")
      });

    $("#create").removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");

    $( "#search" )
      .button()
      .click(function() {
        $(".search_alert").text("Searching...");
        var city = $("#place").val() || "New York";
        var state = $("#state").val() || "NY";
        var place = city+","+state
        var keyword = $("#keyword").val() || "Columbia Univsersity";
        //console.log(placeVal+" "+keyword);
        search(place,keyword);
      });
    $("#search").removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");

    $( "#save" )
      .button()
      .click(function() {
        console.log(unsavedCalenders);
        tabs = $("#tabs");
        var panelId = tabs.find(".ui-tabs-active").attr("aria-controls");
        console.log("You are trying to save schedule "+panelId);
        console.log("The active tab is "+tabs.find(".ui-tabs-active").attr('id'));
        var temp = getObjects(unsavedCalenders["Calenders"],"name",tabs.find(".ui-tabs-active").attr('id'));
        var temp2 = findDuplicate(calenderList["Calenders"],tabs.find(".ui-tabs-active").attr('id'));
        if (temp.length >=1 && temp2<0){
          $("#information").text("Schedule "+tabs.find(".ui-tabs-active").attr('id')+" Saved!");
          $("#informationbox").dialog("open");
          calenderList['Calenders'].push(tabs.find(".ui-tabs-active").attr('id'));
          localStorage.setItem('Calenders',JSON.stringify(calenderList));
          localStorage.setItem(tabs.find(".ui-tabs-active").attr('id'),JSON.stringify(temp[0]));
          console.log("Schedule saved");
          console.log(unsavedCalenders);
        }
        if (temp.length >=1 && temp2>=0){
          $("#information").text("Schedule "+tabs.find(".ui-tabs-active").attr('id')+" Saved!");
          $("#informationbox").dialog("open");
          localStorage.setItem(tabs.find(".ui-tabs-active").attr('id'),JSON.stringify(temp[0]));
          console.log("Schedule saved");
          console.log(unsavedCalenders);
        }
        //localStorage.setItem('tabs',document.getElementById(panelId).innerHTML);
      });
    $("#save").removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
 
    // actual addTab function: adds new tab using the input from the form above
    function addTab() {
        var bValid = true;
        bValid = bValid && checkLength(tabTitle,"schedule name",1,8);
        bValid = bValid && checkRegexp(tabTitle,/^[a-z]([0-9a-z_])+$/i,"Schedule name illegal");
        var tester = getObjects(unsavedCalenders["Calenders"],"name",tabTitle.val());
        console.log("Found "+tester.length+" match");
        if (tester.length > 0) {
          bValid = false;
          updateTips("Schedule name already exist.");
        }
        console.log("New Schedule name is "+tabTitle.val()+" Validation of this name is "+bValid);
        if (bValid){
        var label = tabTitle.val();
        var date = tabDate.val();
        console.log("New Schedule called "+label+". Selected date is "+date);
        var newTab = {"name":label, "time":date,"event_num":0, "event":[]};
        unsavedCalenders['Calenders'].push(newTab);
        //console.log(unsavedCalenders);
        $('#schedule').append(
                            '<li id="'+label+'" style="width:40px"><a href="#tabs-'+label+'">'+label+'</a></li>');
        $("li",$("#schedule")).draggable({
                cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                revert: "invalid", // when not dropped, the item will revert back to its initial position
                containment: "document",
                helper: "clone",
        });
        var tabid = "#tabs-" + label;
        tabpanel='<div id="tabs-'+label+'">'+calendertemplate;
        $("#tabs").append(tabpanel);
        $(tabid).droppable(
                    {
                        accept: "div",
                        drop: function( event, ui ) {
                                console.log("Y position "+event.pageY);
                                console.log("Scrolled Y position "+document.getElementById("tabs").scrollTop);
                                console.log("Scrolled Y position "+document.getElementById("tabs").offsetTop);
                                console.log("div position "+this.offsetTop);
                                console.log("container position "+document.getElementById("container").offsetTop);
                                var fTime = Math.floor((event.pageY+document.getElementById("tabs").scrollTop-document.getElementById("tabs").offsetTop-this.offsetTop-document.getElementById('body').scrollTop)/26);
                                console.log("estimated position starting time is "+fTime);
                                $('#fromHour').val(fTime);
                                $('#fromMinute').val(00);
                                $('#toHour').val(fTime+1);
                                $('#toMinute').val(00);
                                var draggedid = $(ui.draggable).attr('id');
                                var element = document.getElementById(draggedid).getElementsByTagName("a").item(0)
                                clone = element.cloneNode();
                                //console.log($(this).attr('id'));
                                vid= $(this).attr('id');
                                //console.log(vid);
                                $( "#dialog-form" ).dialog( "open" );
                                $( "#calenderName").html('<p id= "calenderName" class="validateTips">Adding to Schedule:'+vid.substr(0,vid.length-4)+'</p>');
                                document.getElementById('body').style.overflow="hidden";
                    }
                }
        )
        $("#tabs").tabs( "refresh" );
        $( "#createCalendar" ).dialog("close");
      }
    }
 
    // addTab button: just opens the dialog


// //Adding event to the calender
      fromHour= $( "#fromHour" ),
      fromMinute = $("#fromMinute"),
      toHour = $( "#toHour" ),
      toMinute = $("#toMinute"),
      comment = $("#comment"),
      allFields = $( [] ).add( fromHour).add( fromMinute).add( toHour).add( toMinute).add( comment ),
      tips = $( ".validateTips" );

      function updateTips( t ) {
              $( ".validateTips" )
                .text( t )
                .addClass( "ui-state-highlight" );
              setTimeout(function() {
                 $( ".validateTips" ).removeClass( "ui-state-highlight", 1500 );
              }, 500 );
        }
 
        $( "#dialog-form" ).position({
            at: "center center",
        });

         $( "#m_dialog-form" ).position({
            at: "center center",
        });

    function checkRegexp( o, regexp, n ) {
      if ( !( regexp.test( o.val() ) ) ) {
        o.addClass( "ui-state-error" );
        updateTips(n);
        return false;
      } else {
        return true;
      }
    }

    function checkLength( o, n, min, max ) {
      if ( o.val().length > max || o.val().length < min ) {
        o.addClass( "ui-state-error" );
        updateTips( "Length of " + n + " must be between " +
          min + " and " + max + "." );
        return false;
      } else {
        return true;
      }
    }

    $( "#m_dialog-form" ).dialog({
      autoOpen: false,
      height: 300,
      width: 350,
      modal: true,
      buttons: {
        "Modify": function() {
            //$("#"+selectedEvent.id).fadeOut();
            var bValid = true;
            bValid = bValid && checkRegexp($("#m_fromHour"),/^([0-9])+$/,"Only Numeric input is allowed for Time");
            bValid = bValid && checkRegexp($("#m_fromMinute"),/^([0-9])+$/,"Only Numeric input is allowed for Time");
            fTime = $("#m_fromMinute").val()/60;
            fTime+=$("#m_fromHour").val()/1;
            if (fTime < 0 || fTime > 24){
                bValid = false;
                updateTips("Input Time exceeds 24 hours");
            }
            bValid = bValid && checkRegexp($("#m_toHour"),/^([0-9])+$/,"Only Numeric input is allowed for Time");
            bValid = bValid && checkRegexp($("#m_toMinute"),/^([0-9])+$/,"Only Numeric input is allowed for Time");
            tTime = ($("#m_toHour").val()/1)+($("#m_toMinute").val()/60);
            if (tTime<0 || tTime > 24){
                bValid = false;
                updateTips("Input Time exceeds 24 hours");
            }
            if (tTime <= fTime){
                bValid = false;
                updateTips("Eding Time is prior to Starting Time");
            }
            if (bValid) {
                var scheduleid = $('#tabs').find(".ui-tabs-active").attr("id");
                    console.log("Modifying event from schedule "+scheduleid);
                    var k = findDuplicate(calenderList["Calenders"],scheduleid);
                    var k2 = removeObjects(unsavedCalenders["Calenders"],"name",scheduleid);
                    var eventid = removeObjects(unsavedCalenders["Calenders"][k2]["event"],"event-id",selectedEvent.id.substr(7,selectedEvent.id.length));
                    unsavedCalenders["Calenders"][k2]["event"][eventid]["fromHour"] = $("#m_fromHour").val();
                    unsavedCalenders["Calenders"][k2]["event"][eventid]["fromMinute"]= $("#m_fromMinute").val();
                    unsavedCalenders["Calenders"][k2]["event"][eventid]["toHour"] = $("#m_toHour").val();
                    unsavedCalenders["Calenders"][k2]["event"][eventid]["toMinute"] = $("#m_toMinute").val();
                    unsavedCalenders["Calenders"][k2]["event"][eventid]["comment"] = $("#m_comment").val();
                console.log("New time "+fTime);
                console.log("New Duration "+(tTime-fTime));
                selectedEvent.style.top = ""+(6+fTime*26)+"px";
                selectedEvent.style.height = ""+((tTime-fTime)*26-2)+"px";
                console.log(selectedEvent);
                $("#"+selectedEvent.id).html("");
                $("#"+selectedEvent.id).append('<a href="'+unsavedCalenders["Calenders"][k2]["event"][eventid]["placeURL"]+'" target="_blank">'+unsavedCalenders["Calenders"][k2]["event"][eventid]["placeName"]+'</a>');
                $("#"+selectedEvent.id).append("<p>"+unsavedCalenders["Calenders"][k2]["event"][eventid]["comment"]+"</p>");
                $("#"+selectedEvent.id).show();
                //$("#"+vid).append('<div id="delete-'+vid+'"draggable="true" ondragstart="drag(event)">'+clone+'</div>');
                allFields.val( "" ).removeClass( "ui-state-error" );
                $( this ).dialog( "close" );
                document.getElementById('body').style.overflow="scroll";
            }
        },
        Cancel: function() {
          $( this ).dialog( "close" );
          document.getElementById('body').style.overflow="scroll";
        }
      },
      close: function() {
        allFields.val( "" ).removeClass( "ui-state-error" );
        document.getElementById('body').style.overflow="scroll";
      }
    });

    $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 300,
      width: 350,
      modal: true,
      buttons: {
        "Add to Calender": function() {
            var bValid = true;
            bValid = bValid && checkRegexp(fromHour,/^([0-9])+$/,"Only Numeric input is allowed for Time");
            bValid = bValid && checkRegexp(fromMinute,/^([0-9])+$/,"Only Numeric input is allowed for Time");
            fTime = fromMinute.val()/60;
            fTime+=fromHour.val()/1;
            if (fTime < 0 || fTime > 24){
                bValid = false;
                updateTips("Input Time exceeds 24 hours");
            }
            bValid = bValid && checkRegexp(toHour,/^([0-9])+$/,"Only Numeric input is allowed for Time");
            bValid = bValid && checkRegexp(toMinute,/^([0-9])+$/,"Only Numeric input is allowed for Time");
            tTime = (toHour.val()/1)+(toMinute.val()/60);
            if (tTime<0 || tTime > 24){
                bValid = false;
                updateTips("Input Time exceeds 24 hours");
            }
            if (tTime <= fTime){
                bValid = false;
                updateTips("Eding Time is prior to Starting Time");
            }
            if (bValid) {
                var newEvent = {"event-id":"","fromHour": fromHour.val(), "fromMinute": fromMinute.val(), "toHour": toHour.val(), "toMinute": toMinute.val(), "comment":comment.val(),"placeURL":clone.href,"placeName":clone.innerHTML};
                var vid = $("#tabs").find(".ui-tabs-active").attr("aria-controls");
                console.log("You are now adding to schedule "+vid);
                var a = getObjects(unsavedCalenders["Calenders"],"name",$("#tabs").find(".ui-tabs-active").attr("id"));
                var tempLength = 0;
                var eventId;
                if (a.length >= 1) {
                  a[0]["event_num"]+=1;
                  tempLength = a[0]['event_num'];
                  eventId = vid+"-"+tempLength;
                  newEvent["event-id"]=eventId;
                  a[0]["event"].push(newEvent);
                  console.log("Event added! Updated list shown below");
                  console.log(unsavedCalenders);
                }
                //var eventId = vid+"-"+tempLength;
                console.log("Your new event's id is "+eventId);
                var t = (tTime-fTime)*26-2;
                var slot = document.getElementById(vid).getElementsByTagName('div').item(1);
                var top = 6+26*fTime;
                $(slot).append('<div id="delete-'+eventId+'" title="Click to edit" class="event_div" style="top:'+top+'px;height:'+t+'px"></div>');
                $("#delete-"+eventId).append(clone);
                $("#delete-"+eventId).append("<p>"+comment.val()+"</p>");
                $("#delete-"+eventId).button().click(function(){
                    selectedEvent = this;
                    console.log("You selece this event");
                    console.log(this);
                    var scheduleid = $('#tabs').find(".ui-tabs-active").attr("id");
                    console.log("Adding event to schedule "+scheduleid);
                    var k = findDuplicate(calenderList["Calenders"],scheduleid);
                    var k2 = removeObjects(unsavedCalenders["Calenders"],"name",scheduleid);
                    var eventid = removeObjects(unsavedCalenders["Calenders"][k2]["event"],"event-id",this.id.substr(7,this.id.length));
                    if (eventid!=-1){
                        $("#m_fromHour").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["fromHour"]);
                        $("#m_fromMinute").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["fromMinute"]);
                        $("#m_toHour").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["toHour"]);
                        $("#m_toMinute").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["toMinute"]);
                        $("#m_comment").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["comment"]);
                    }
                    $("#m_dialog-form").dialog("open");
                });
                $("#delete-"+eventId).removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                $("#delete-"+eventId).draggable({
                    cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                    revert: "invalid", // when not dropped, the item will revert back to its initial position
                    containment: "document",
                    helper: "clone",
                    cursor: "move"
                });
                //$("#"+vid).append('<div id="delete-'+vid+'"draggable="true" ondragstart="drag(event)">'+clone+'</div>');
                allFields.val( "" ).removeClass( "ui-state-error" );
                $( this ).dialog( "close" );
                document.getElementById('body').style.overflow="scroll";
            }
        },
        Cancel: function() {
          $( this ).dialog( "close" );
          document.getElementById('body').style.overflow="scroll";
        }
      },
      close: function() {
        allFields.val( "" ).removeClass( "ui-state-error" );
        document.getElementById('body').style.overflow="scroll";
      }
    });
  });

    var config = {
        apiKey : 'NFAOLYM5EJBOO4RB11JLRMNZNH0ZHQTY0X3KMBYRYUALUPOS',
        apisecret : 'FAAFWOOSW3OB44DEUKWZF2KDTAI3ODHAEKSJ5MCRZWPERCQL',
        authUrl : 'https://foursquare.com/',
        apiUrl : 'https://api.foursquare.com/'
    };
    function search(place, keyword){
        var success = false;
        $.getJSON(config.apiUrl + 'v2/venues/explore?near=' + place
                                + '&query=' + keyword + '&client_id='
                                + config.apiKey + '&client_secret='
                                + config.apisecret,
                        //{},
                        function(data) {
                            success = true;
                            console.log("Target place "+data['response']['headerLocation']);
                            if (data['response']['warning']!=null){
                              updateAlerts(data['response']['warning']['text']);
                            }
                            else {updateAlerts("Results loaded! Target Place: "+data['response']['headerLocation']+", Key word: "+data['response']['query']);}
                            venues = data['response']['groups'][0]['items'];
                            if (document.getElementById("results")==null) {
                                $('#container').append(
                                    '<table id="results" class="search_result">');
                            }
                            /* Place marker for each venue. */
                            
                            else {$('#results').html("");}
                            for (var i = 0; i < venues.length; i++) {
                                var name = venues[i]['venue']['name'];
                                var url = "https://foursquare.com/v/" + name
                                        + "/" + venues[i]['venue']['id'];
                                var address = venues[i]['venue']['location']['address']
                                        + "("
                                        + venues[i]['venue']['location']['crossStreet']
                                        + ")";
                                var price = ";"
                                if (venues[i]['venue']['price']){
                                    var dollars = venues[i]['venue']['price']['tier'];
                                    price = '<span class="venueDataItem"><span class="price" title=""><span class="darken" itemprop="priceRange">';
                                    for (k=0;k<dollars;k++){
                                        price+='$';
                                    }
                                    price+='</span></span>'
                                }
                                else price = '<span class="venueDataItem"><span class="price" title=""><span class="darken" itemprop="priceRange">undefined</span></span>';
                                var venueName = '<div class="venueName"><a href="'+url+'" target="_blank">'+name+'</a></div><span class="venueScore positive" title="">'+venues[i]['venue']['rating']+'</span>';
                                var address = '<div class="venueAddress">'+address+'</div>';
                                
                                
                                var resultblock= '<tr><td><div class="venueBlock" id="drag-'+ i+ '">'
                                                        +'<div class="venueDetails">'
                                                        +venueName+'<div class="venueAddressData">'
                                                        +address
                                                        +'<div class="venueData">'+price+'</div></div></div><div style="clear:both"></div></td></tr>';
                                $('#results').append(resultblock);
                                $("#drag-"+i).draggable({
                                    cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                                    revert: "invalid", // when not dropped, the item will revert back to its initial position
                                    containment: "document",
                                    helper: "clone",
                                    cursor: "move"
                                });
                            }
                            $('#container').append('</table>');
                        })
        setTimeout(function(){
          if (!success){
            updateAlerts("Sorry, your search is invalid. Please modify and try again.");}
        },200);
    }
    function onLoadEvent() {
        $("#tabs").tabs().addClass("ui-tabs-vertical ui-helper-clearfix");
        $("#tabs li").removeClass("ui-corner-top").addClass("ui-corner-left");
        console.log("Loading");
        console.log("Calender in storage"+localStorage.getItem("Calenders"));
        if (localStorage.getItem("Calenders")==null){
            calenderList = {"Calenders":[],};
            localStorage.setItem("Calenders",JSON.stringify(calenderList));
        }
        else {
            calenderList = JSON.parse(localStorage.getItem("Calenders"));
        }
        console.log("You have "+calenderList['Calenders'].length+" schedules in storage");
        if (calenderList['Calenders'].length==0){
            $( "#createCalendar" ).dialog("open");
            updateTips("You have no calenders right now. Creat one?");
            console.log("Creating new schedule for you");
        }
        else {
            for(i=0;i<calenderList['Calenders'].length;i++){
                console.log("Loading schedule No."+i+" Called "+calenderList['Calenders'][i]);
                var newTab = JSON.parse(localStorage.getItem(calenderList['Calenders'][i]));
                unsavedCalenders['Calenders'].push(newTab);
                drawTab(newTab,calenderList['Calenders'][i]);
                tabCounter+=1;
            }
        }
    }

    function updateTips( t ) {
              $( ".validateTips" )
                .text( t )
                .addClass( "ui-state-highlight" );
              setTimeout(function() {
                tips.removeClass( "ui-state-highlight", 1500 );
              }, 500 );
    }

    function updateAlerts( t ) {
              $( ".search_alert" )
                .text( t )
                .addClass( "ui-state-highlight" );
              setTimeout(function() {
                 $( ".search_alert"  ).removeClass( "ui-state-highlight", 1500 );
              }, 500 );
        }

    function drawTab(newTab,tabid) {
        console.log("Drawing schedule event for schedule "+tabid);
        console.log("Current schedule is "+localStorage.getItem(calenderList['Calenders'][i]));
        var label = newTab['name']||"newSchedule-"+i,
        id = "tag-"+i;
        $('#schedule').append(
                            '<li id="'+tabid+'" style="width:40px"><a href="#tabs-'+tabid+'">'+label+'</a></li>');
        $("li",$("#schedule")).draggable({
                cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                revert: "invalid", // when not dropped, the item will revert back to its initial position
                containment: "document",
                helper: "clone",
                cursor: "move"
        });
        tabpanel='<div id="tabs-'+tabid+'">'+calendertemplate;
        $("#tabs").append(tabpanel);
        $("#tabs-"+tabid).droppable(
                    {
                        drop: function( event, ui ) {
                                console.log("Y position "+event.pageY);
                                console.log("Scrolled Y position "+document.getElementById("tabs").scrollTop);
                                console.log("Scrolled Y position "+document.getElementById("tabs").offsetTop);
                                console.log("div position "+this.offsetTop);
                                console.log("container position "+document.getElementById("container").offsetTop);
                                var fTime = Math.floor((event.pageY+document.getElementById("tabs").scrollTop-document.getElementById("tabs").offsetTop-this.offsetTop-document.getElementById('body').scrollTop)/26);
                                console.log("estimated position starting time is "+fTime);
                                $('#fromHour').val(fTime);
                                $('#fromMinute').val(00);
                                $('#toHour').val(fTime+1);
                                $('#toMinute').val(00);
                                var draggedid = $(ui.draggable).attr('id');
                                var element = document.getElementById(draggedid).getElementsByTagName("a").item(0)
                                clone = element.cloneNode();
                                vid= $(this).attr('id');
                                $( "#dialog-form" ).dialog( "open" );
                                $( "#calenderName").html('<p id= "calenderName" class="validateTips">Adding to Schedule:'+vid.substr(0,vid.length-4)+'</p>');
                                document.getElementById('body').style.overflow="hidden";
                    }
                }
        )
        var counter = 0;
        for (var j=0;j<newTab['event'].length;j++){
                var currentEvent = newTab['event'][counter];
                var fTime = currentEvent['fromHour']/1 + currentEvent['fromMinute']/60;
                var tTime = currentEvent['toHour']/1 + currentEvent['toMinute']/60;
                var eventId = currentEvent['event-id'];
                var placeUrl = currentEvent['placeURL'];
                var placeName = currentEvent['placeName'];
                var t = (tTime-fTime)*26-2;
                var slot = document.getElementById("tabs-"+tabid).getElementsByTagName('div').item(1);
                var top = 6+26*fTime;
                $(slot).append('<div id="delete-'+eventId+'" title="Clike to Edit" class="event_div" style="top:'+top+'px;height:'+t+'px"></div>');
                //console.log(currentEvent['placeURl']);
                $("#delete-"+eventId).append('<a href="'+placeUrl+'" target="_blank">'+placeName+'</a>');
                $("#delete-"+eventId).append("<p>"+currentEvent['comment']+"</p>");
                $("#delete-"+eventId).button().click(function(){
                    selectedEvent = this;
                    console.log("You selece this event");
                    console.log(this);
                    var scheduleid = $('#tabs').find(".ui-tabs-active").attr("id");
                    console.log("Deleting event from schedule "+scheduleid);
                    var k = findDuplicate(calenderList["Calenders"],scheduleid);
                    var k2 = removeObjects(unsavedCalenders["Calenders"],"name",scheduleid);
                    var eventid = removeObjects(unsavedCalenders["Calenders"][k2]["event"],"event-id",this.id.substr(7,this.id.length));
                    if (eventid!=-1){
                        $("#m_fromHour").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["fromHour"]);
                        $("#m_fromMinute").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["fromMinute"]);
                        $("#m_toHour").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["toHour"]);
                        $("#m_toMinute").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["toMinute"]);
                        $("#m_comment").val(unsavedCalenders["Calenders"][k2]["event"][eventid]["comment"]);
                    }
                    $("#m_dialog-form").dialog("open");
                });
                $("#delete-"+eventId).removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                $("#delete-"+eventId).draggable({
                    cancel: "a.ui-icon", // clicking an icon won't initiate dragging
                    revert: "invalid", // when not dropped, the item will revert back to its initial position
                    containment: "document",
                    helper: "clone",
                    cursor: "move"
                });
                counter+=1;
        }
        $("#tabs").tabs("refresh");
    }
    function closeWindow(){
      if(confirm()){ return true;}
      return false;
    }
    var confirmOnPageExit = function (e) 
{
    // If we haven't been passed the event get the window.event
    e = e || window.event;

    var message = 'Leaving page will delete unsaved changes.';

    // For IE6-8 and Firefox prior to version 4
    if (e) 
    {
        e.returnValue = message;
    }

    // For Chrome, Safari, IE8+ and Opera 12+
    return message;
};
window.onbeforeunload = confirmOnPageExit;
</script>
</head>
<body id="body" onload="onLoadEvent()">
    <!-- Fixed navbar -->
      <div id="delete-confirm" title="Delete This Item for ever?">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>These items will be permanently deleted and cannot be recovered. Are you sure?</p>
      </div>
      <div id="informationbox" title="Information box">
        <p id="information"><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>These items will be permanently deleted and cannot be recovered. Are you sure?</p>
      </div>
      <div id="dialog-form" title="Adding new event">
        <div id="calenderName"></div>
        <p class="validateTips">Comments is optional.</p>
        <form>
          <fieldset>
            <label for="name">From:</label>
            <input type="text" name="fromHour" id="fromHour" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <span style="width:5%"> : </span>
            <input type="text" name="fromMinute" id="fromMinute" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <label for="email">To Hour:</label>
            <input type="text" name="toHour" id="toHour" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <span tyle="width:5%">:</span>
            <input type="text" name="toMinute" id="toMinute" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <label for="password">Comments:</label>
            <input type="text" name="comment" id="comment" value="" class="text ui-widget-content ui-corner-all">
          </fieldset>
        </form>
      </div>

      <div id="m_dialog-form" title="Modify event">
        <div id="m_calenderName"></div>
        <p class="validateTips">Comments is optional.</p>
        <form>
          <fieldset>
            <label for="name">From:</label>
            <input type="text" name="m_fromHour" id="m_fromHour" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <span style="width:5%"> : </span>
            <input type="text" name="m_fromMinute" id="m_fromMinute" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <label for="email">To Hour:</label>
            <input type="text" name="m_toHour" id="m_toHour" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <span tyle="width:5%">:</span>
            <input type="text" name="m_toMinute" id="m_toMinute" class="text ui-widget-content ui-corner-all" style="width:30%;display:inline-block">
            <label for="password">Comments:</label>
            <input type="text" name="m_comment" id="m_comment" value="" class="text ui-widget-content ui-corner-all">
          </fieldset>
        </form>
      </div>

      <div id="createCalendar" title="Creating new Schedule">
          <form>
            <fieldset class="ui-helper-reset">
              <p class="validateTips"> </p>
              <p>Choose date by clicking the input area</p>
              <label for="tab_title">Title</label>
              <input type="text" name="tab_title" id="tab_title" value="" class="ui-widget-content ui-corner-all" title="Schedule name may consist of a-z, 0-9, underscores, begin with a letter, within length of 1 to 8">
              <label for="tab_date">Date</label>
              <input type="text" name="datepicker" readonly="true" onmousedown="return true" id="datepicker" class="ui-widget-content ui-corner-all">
            </fieldset>
          </form>
       </div>
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span> <span
                        class="icon-bar"></span> <span class="icon-bar"></span> <span
                        class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="advanced_calender.html">Trip Planner</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li id="schedules" class="dropdown"></li>
                </ul>
            </div>
        </div>
        <!--/.nav-collapse -->
    </div>
    <!-- Main component for a primary marketing message or call to action -->
    <div id="container" class="jumbotron">
        <p class="search_alert"></p>
        <form style="font-size:20px">
        <fieldset class="ui-helper-reset">
          <label for="tab_title">City</label>
          <input type="text" name="place" id="place" value="New York" class="ui-widget-content ui-corner-all" style="display:inline-block" title="Target City">
          <label for="tab_title">State</label>
          <input type="text" name="state" id="state" value="NY" class="ui-widget-content ui-corner-all" style="display:inline-block" title="Corresponding State">
          <label for="tab_date">Key word</label>
          <input name="tab_content" id="keyword" value="Columbia University" class="ui-widget-content ui-corner-all" title="Interested Properties"></intput>
        </fieldset>
        </form>
         <button id="search" class="btn btn-default">search</button>
        <div id="tabs">
            <ul id="schedule" class="btn-group-vertical" style="float: left;">
            </ul>
        </div>
        <div class="btn-group" style="position:fixed;top:90%;right:10%;">
            <button id="save" type="button" class="btn btn-default" title="Save only selected schedule">Save</button>
            <button id="create" type="button" class="btn btn-default">Create Schedule</button>
            <div id="delete" name="delete" style="width:80px;height:34px;padding:0px; text-align: center;" class="btn btn-default" title="Drag event or Schedule tab to here to delete"><p style="position:absolute;top:7px; left:16px">Delete</p></div>
        </div>
        <!-- <table id="results" class="search_result"></table> -->

        <div style="clear: both"></div>
</div>